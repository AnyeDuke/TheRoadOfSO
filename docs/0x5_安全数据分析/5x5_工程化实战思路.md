

# 工程化实战思路

本篇整理了在安全数据分析方向的工程化实战思路。



## 思路一：云环境自动化入侵溯源实战

整理自阿里云安全工程师 徐越师傅的KCon分享[1]。

### 如何评估

> 响应速度是企业安全能力的核心体现

简单来看，安全数据分析的落地，时常遇到理想很丰满，现实很骨感的情况。从企业安全角度出发，能提升响应速度是关键。



### 现状分析

企业安全的中心，SoC的安全运营过程中遇到的问题有：

-   数据缺失
    -   该有的没有，不该有的一大堆
-   系统孤立
    -   告警、流量、情报、主机各个系统都有自己独立的一套，并且输出的数据都不相同
-   人工检索
    -   还是依靠人工来排查上述那些系统的数据



### 需求

-   多途径数据收集 —— 从多个系统和设备中获取数据
-   异构数据整合 —— 不一样格式的数据能放一块
-   自动化的知识表达 —— 人看得懂，人看得了，人能偷懒点



### Demo

![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200719221622.png)

从Demo中可以看出来，这个系统还是属于初级阶段，节点属性不是很丰富，主要是做了哈希摘要和类型识别。从左侧可以看出，其整合了多个系统数据源，并在这个云环境下，实现了一个挖矿程序的路径溯源。

在数据层面如何实现？猜测可能还是从挖矿程序的算法特征结合源IP进行的关联、匹配得出。



### 	计算流程

![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200719222328.png)

从图中可以看出，数据源来自：情报、主机日志、云服务、漏洞检测、蜜罐。

流计算引擎采用了Blink（阿里魔改的Flink）。

然后进行了大数据处理常用的构成、便利、裁剪等过程，比较模糊。图算法的关联？

最后是输出一个可交互的溯源后攻击路径。



### 核心概念

#### 行为过程

在这个思路里，以黑客**行为**为基准，然后使用实体表述，以描述入侵的完整过程。

<img src="https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200719223112.png" style="zoom:50%;" />



#### 被动分析

主要指基于攻击后的日志信息，进行攻击路径上每个环节下数据的关联。简单讲，就是每个攻击环节下留下来的数据，找到之间的关系，能关联起来。这个阶段主要是基于规则进行的自动化处理。

<img src="https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200719223812.png" style="zoom:50%;" />



#### 主动推理

主动关系推理，需要专家经验加入，对攻击路径进行的一系列关系探索。

-   相似字符串匹配
-   全局统计基线
-   巨雷重合检验

![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200719224052.png)



#### 断链修复

有经验的同学看到上面的路径方案，就会想到，依靠算法和部分专家经验，这种攻击路径的准确率比较感人。而且容易存在断链的情况。一下是徐越师傅这边给出的**关联规则挖掘**方案。

![image-20200719230023928](/Users/satan1a/Library/Application Support/typora-user-images/image-20200719230023928.png)



### 案例

以下是一个watchbog 蠕虫回溯案例

![](https://image-host-toky.oss-cn-shanghai.aliyuncs.com/20200719230054.png)



### 辅助

#### 宏观入侵原因统计

从宏观角度统计全网（按月）的各种入侵原因，从各个威胁类型角度。e.g. 挖矿程序植入方式、WEBSHELL植入方式。

#### 自动化0day捕获

需要依赖强大的数据源支撑以及...运气。









## References

[1] 云环境自动化入侵溯源实战》，KCon 2019， [[slides\]](https://link.zhihu.com/?target=https%3A//static.cdxy.me/201908-%E4%BA%91%E7%8E%AF%E5%A2%83%E8%87%AA%E5%8A%A8%E5%8C%96%E5%85%A5%E4%BE%B5%E6%BA%AF%E6%BA%90%E5%AE%9E%E6%88%98-KCon.pdf)

